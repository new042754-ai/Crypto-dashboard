<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CryptoTrader</title>
  <style>
    /* Base UI */
    body{font-family:Arial,sans-serif;background:#111;color:#fff;margin:0;padding:0;text-align:center}
    header{display:flex;justify-content:center;gap:10px;padding:10px;background:#222;position:sticky;top:0;z-index:10}
    button{padding:10px 20px;border:none;border-radius:6px;cursor:pointer;font-weight:700}
    .btn-btc,.btn-eth{background:#333;color:#fff}
    .btn-start{background:green;color:#fff}
    .btn-stop{background:brown;color:#fff}
    .status{margin:10px 0;font-weight:700}
    .status.stopped{color:#ff3b3b}
    .status.running{color:#16a34a}

    .price-card{background:#222;padding:15px;border-radius:12px;margin:12px auto;width:260px;cursor:pointer;box-shadow:0 8px 24px rgba(0,0,0,.35)}
    .price{font-size:1.6em;margin-top:6px}

    /* Chart overlay */
    .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:9999;flex-direction:column}
    .overlay.show{display:flex}
    .overlay-header{display:flex;justify-content:space-between;align-items:center;background:#000;padding:10px 12px}
    #tv-container{flex:1}

    /* Strategy widget */
    .strategy-card{background:#1c1c1c;border-radius:20px;padding:16px;display:flex;flex-direction:column;align-items:center;gap:10px;box-shadow:0 10px 30px rgba(0,0,0,.45);max-width:300px;margin:18px auto}
    .strategy-title{font-weight:800;color:#ff3b3b;background:#111;padding:6px 12px;border-radius:12px;letter-spacing:.3px}
    .strategy-plus{width:70px;height:70px;border-radius:18px;border:none;background:#0f0f0f;font-size:36px;line-height:1;color:#ff3b3b;box-shadow:inset 0 0 0 2px #2a2a2a;cursor:pointer}
    .strategy-summary{font-size:12px;color:#bbb;text-align:center}

    .strategy-modal::backdrop{background:rgba(0,0,0,.6)}
    .strategy-modal{border:none;border-radius:20px;padding:0;background:#111;color:#eee;width:min(92vw,560px)}
    .strategy-form{padding:16px}
    .strategy-form-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .close-btn{background:#1f1f1f;border:none;color:#bbb;font-size:22px;width:36px;height:36px;border-radius:10px}
    .row{display:flex;justify-content:space-between;align-items:center;margin:10px 0;gap:12px}
    .row span{color:#bbb}
    .row input,.row select{flex:1;background:#181818;border:1px solid #2a2a2a;border-radius:10px;color:#eee;padding:8px}
    .param-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .actions{display:flex;justify-content:flex-end;gap:10px;margin-top:12px}
    .btn.primary{background:#16a34a;color:#fff}
    .btn.secondary{background:#333;color:#ddd}
  </style>
</head>
<body>

  <header>
    <button class="btn-btc" id="btn-btc">BTC</button>
    <button class="btn-eth" id="btn-eth">ETH</button>
    <button class="btn-start" id="start">Start</button>
    <button class="btn-stop" id="stop">Stop</button>
  </header>

  <div id="algo-status" class="status stopped">Algo Stopped</div>

  <div class="price-card" id="card-btc">
    <div>BTC</div>
    <div class="price" id="price-btc">--</div>
  </div>

  <div class="price-card" id="card-eth">
    <div>ETH</div>
    <div class="price" id="price-eth">--</div>
  </div>

  <!-- Strategy Widget -->
  <div id="strategy-card" class="strategy-card">
    <div class="strategy-title">Strategy</div>
    <button id="open-strategy" class="strategy-plus">+</button>
    <div id="strategy-summary" class="strategy-summary">None selected</div>
  </div>

  <dialog id="strategy-modal" class="strategy-modal">
    <form method="dialog" id="strategy-form" class="strategy-form">
      <div class="strategy-form-header">
        <h3>Choose Strategy</h3>
        <button type="button" id="close-strategy" class="close-btn">×</button>
      </div>

      <label class="row">
        <span>Type</span>
        <select id="strategy-type">
          <option value="SMA">SMA Crossover</option>
          <option value="RSI">RSI</option>
          <option value="MACD">MACD</option>
          <option value="VWAP">VWAP</option>
        </select>
      </label>

      <div id="params-area"></div>

      <div class="actions">
        <button value="cancel" class="btn secondary">Cancel</button>
        <button id="save-strategy" value="default" class="btn primary">Save</button>
      </div>
    </form>
  </dialog>

  <!-- Chart overlay -->
  <div class="overlay" id="overlay">
    <div class="overlay-header">
      <span id="overlay-title"></span>
      <button id="ov-close">Close</button>
    </div>
    <div id="tv-container"></div>
  </div>

  <script src="https://s3.tradingview.com/tv.js"></script>
  <script>
    /* ----------------- Status & Prices ----------------- */
    const statusEl = document.getElementById('algo-status');

    async function fetchPrice(symbol, el){
      try{
        const r = await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${symbol}`);
        const d = await r.json();
        el.textContent = `$${(+d.price).toLocaleString()}`;
      }catch{ el.textContent = '--'; }
    }
    function updatePrices(){
      fetchPrice('BTCUSDT', document.getElementById('price-btc'));
      fetchPrice('ETHUSDT', document.getElementById('price-eth'));
    }
    updatePrices(); setInterval(updatePrices, 5000);

    /* ----------------- TV Chart ----------------- */
    const overlay = document.getElementById('overlay');
    const overlayTitle = document.getElementById('overlay-title');
    const tvContainer = document.getElementById('tv-container');
    let tvWidget = null, lastChart = null;

    function tfToInterval(tf){
      return tf==='1m' ? '1' : tf==='5m' ? '5' : tf==='15m' ? '15' : tf==='1h' ? '60' : '60';
    }

    // USE studies param (reliable in TV embed) so indicators appear
    function openChart(label, symbol, cfg){
      const type = cfg?.type || 'SMA';
      const p = cfg?.params || {};
      const interval = tfToInterval(p.timeframe || '1h');

      const studiesByType = {
        SMA:  ['MASimple@tv-basicstudies','MASimple@tv-basicstudies'], // 2 MAs
        RSI:  ['RSI@tv-basicstudies'],
        MACD: ['MACD@tv-basicstudies'],
        VWAP: ['VWAP@tv-basicstudies']
      };
      const studies = studiesByType[type] || [];

      overlay.classList.add('show');
      overlayTitle.textContent = label + ' — TradingView';
      tvContainer.innerHTML = '';

      tvWidget = new TradingView.widget({
        autosize: true,
        symbol: symbol,
        interval: interval,
        timezone: "Etc/UTC",
        theme: "dark",
        style: "1",
        container_id: "tv-container",
        locale: "en",
        withdateranges: true,
        allow_symbol_change: false,
        studies: studies
      });
    }

    document.getElementById('card-btc').onclick = () => {
      lastChart = { label: 'BTC/USDT', symbol: 'BINANCE:BTCUSDT' };
      openChart(lastChart.label, lastChart.symbol, window.getStrategyConfig());
    };
    document.getElementById('card-eth').onclick = () => {
      lastChart = { label: 'ETH/USDT', symbol: 'BINANCE:ETHUSDT' };
      openChart(lastChart.label, lastChart.symbol, window.getStrategyConfig());
    };
    document.getElementById('ov-close').onclick = () => overlay.classList.remove('show');

    /* ----------------- Strategy Widget ----------------- */
    (function(){
      const STORAGE_KEY = 'strategyConfig';
      const defaults = {
        SMA:  { fast:20, slow:50, timeframe:'1m' },
        RSI:  { period:14, overbought:70, oversold:30, timeframe:'1m' },
        MACD: { fast:12, slow:26, signal:9, timeframe:'1m' },
        VWAP: { session:'session', timeframe:'1m' }
      };

      const el = {
        open: document.getElementById('open-strategy'),
        modal: document.getElementById('strategy-modal'),
        close: document.getElementById('close-strategy'),
        type: document.getElementById('strategy-type'),
        params: document.getElementById('params-area'),
        save: document.getElementById('save-strategy'),
        summary: document.getElementById('strategy-summary')
      };

      function loadCfg(){ try{return JSON.parse(localStorage.getItem(STORAGE_KEY))||null}catch{return null} }
      function saveCfg(cfg){ localStorage.setItem(STORAGE_KEY, JSON.stringify(cfg)); updateSummary(cfg); }
      function updateSummary(cfg){
        if(!cfg){ el.summary.textContent='None selected'; return; }
        const p = Object.entries(cfg.params).map(([k,v])=>`${k}:${v}`).join(' | ');
        el.summary.textContent = `${cfg.type} — ${p}`;
      }

      function renderParams(type, init){
        const html = {
          SMA:`<div class="param-grid">
                 <label class="row"><span>Fast</span><input id="p-fast" type="number" min="1" value="${init.fast}"></label>
                 <label class="row"><span>Slow</span><input id="p-slow" type="number" min="2" value="${init.slow}"></label>
               </div>
               <label class="row"><span>Timeframe</span>
                 <select id="p-timeframe"><option>1m</option><option>5m</option><option>15m</option><option>1h</option></select>
               </label>`,
          RSI:`<div class="param-grid">
                 <label class="row"><span>Period</span><input id="p-period" type="number" min="2" value="${init.period}"></label>
                 <label class="row"><span>Overbought</span><input id="p-ob" type="number" value="${init.overbought}"></label>
                 <label class="row"><span>Oversold</span><input id="p-os" type="number" value="${init.oversold}"></label>
               </div>
               <label class="row"><span>Timeframe</span>
                 <select id="p-timeframe"><option>1m</option><option>5m</option><option>15m</option><option>1h</option></select>
               </label>`,
          MACD:`<div class="param-grid">
                 <label class="row"><span>Fast</span><input id="p-fast" type="number" min="1" value="${init.fast}"></label>
                 <label class="row"><span>Slow</span><input id="p-slow" type="number" min="2" value="${init.slow}"></label>
                 <label class="row"><span>Signal</span><input id="p-signal" type="number" min="1" value="${init.signal}"></label>
               </div>
               <label class="row"><span>Timeframe</span>
                 <select id="p-timeframe"><option>1m</option><option>5m</option><option>15m</option><option>1h</option></select>
               </label>`,
          VWAP:`<label class="row"><span>Session</span>
                 <select id="p-session"><option value="session">Session</option><option value="daily">Daily</option><option value="weekly">Weekly</option></select>
               </label>
               <label class="row"><span>Timeframe</span>
                 <select id="p-timeframe"><option>1m</option><option>5m</option><option>15m</option><option>1h</option></select>
               </label>`
        }[type];
        el.params.innerHTML = html;
        const tf = el.params.querySelector('#p-timeframe'); if(tf) tf.value = init.timeframe;
      }

      el.open.addEventListener('click', ()=>{
        const cfg = loadCfg();
        const type = cfg?.type || 'SMA';
        el.type.value = type;
        renderParams(type, cfg?.params || defaults[type]);
        el.modal.showModal();
      });
      el.close.addEventListener('click', ()=> el.modal.close());
      el.type.addEventListener('change', (e)=> renderParams(e.target.value, defaults[e.target.value]));

      el.save.addEventListener('click', (e)=>{
        e.preventDefault();
        const type = el.type.value;
        const q = (id)=> el.params.querySelector(id);
        const params =
          type==='SMA'  ? { fast:+q('#p-fast').value, slow:+q('#p-slow').value, timeframe:q('#p-timeframe').value } :
          type==='RSI'  ? { period:+q('#p-period').value, overbought:+q('#p-ob').value, oversold:+q('#p-os').value, timeframe:q('#p-timeframe').value } :
          type==='MACD' ? { fast:+q('#p-fast').value, slow:+q('#p-slow').value, signal:+q('#p-signal').value, timeframe:q('#p-timeframe').value } :
          type==='VWAP' ? { session:q('#p-session').value, timeframe:q('#p-timeframe').value } : {};
        const cfg = { type, params };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(cfg));
        updateSummary(cfg);
        el.modal.close();
        window.dispatchEvent(new CustomEvent('strategy:changed', { detail: cfg }));
      });

      // expose getter
      window.getStrategyConfig = ()=> loadCfg() || { type:'SMA', params: defaults.SMA };
      // init summary
      updateSummary(loadCfg());
    })();

    /* ----------------- Start / Stop ----------------- */
    document.getElementById('start').onclick = () => {
      const cfg = window.getStrategyConfig();
      console.log('Starting algo with strategy:', cfg);
      statusEl.textContent = 'Algo Running';
      statusEl.className = 'status running';
      // TODO: backend/bot ko cfg ke saath call karo
    };
    document.getElementById('stop').onclick = () => {
      statusEl.textContent = 'Algo Stopped';
      statusEl.className = 'status stopped';
    };
  </script>
</body>
</html>
